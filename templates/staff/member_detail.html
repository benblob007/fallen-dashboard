{% extends "base.html" %}
{% block title %}Member Detail{% endblock %}
{% block content %}
<section class="section">
    <div class="staff-nav">
        <a href="/staff" class="staff-nav-link">Overview</a>
        <a href="/staff/members" class="staff-nav-link active">Members</a>
        <a href="/staff/analytics" class="staff-nav-link">Analytics</a>
        <a href="/staff/guardian" class="staff-nav-link">Guardian</a>
        <a href="/staff/audit" class="staff-nav-link">Audit Log</a>
    </div>
    <a href="/staff/members" class="btn btn-sm" style="margin-bottom:16px">‚Üê Back</a>
    {% if success %}
    <div class="success-banner">
        ‚úÖ Action queued! The bot will execute it within ~30 seconds.
        {% if success == 'warn_queued' %}Warning{% elif success == 'timeout_queued' %}Timeout{% elif success == 'xp_queued' %}XP adjustment{% elif success == 'coins_queued' %}Coin adjustment{% elif success == 'elo_queued' %}ELO change{% elif success == 'warn_remove_queued' %}Warning removal{% endif %} pending.
    </div>
    {% endif %}
    {% if not member %}
    <div class="empty-state"><h2>Not Found</h2><p>No data for this user.</p></div>
    {% else %}
    <div class="member-detail-header">
        <h2>{{ member.roblox_username or 'Unknown' }} <span class="uid">({{ member.user_id }})</span></h2>
        {% if member.verified %}<span class="verified-badge">‚úì Verified</span>{% endif %}
        {% if member.stage_rank %}<span class="stage-badge-lg">‚öîÔ∏è Stage #{{ member.stage_rank }}</span>{% endif %}
    </div>

    <div class="stat-grid compact">
        <div class="stat-card"><div class="stat-value">{{ member.level or 0 }}</div><div class="stat-label">Level</div></div>
        <div class="stat-card"><div class="stat-value">{{ (member.xp or 0)|fnum }}</div><div class="stat-label">XP</div></div>
        <div class="stat-card"><div class="stat-value">{{ (member.coins or 0)|fnum }}</div><div class="stat-label">Coins</div></div>
        <div class="stat-card"><div class="stat-value">{{ member.elo_rating or 1000 }}</div><div class="stat-label">ELO</div></div>
        <div class="stat-card"><div class="stat-value">{{ (member.messages or 0)|fnum }}</div><div class="stat-label">Messages</div></div>
        <div class="stat-card"><div class="stat-value">{{ (member.voice_time or 0)|ftime }}</div><div class="stat-label">Voice</div></div>
        <div class="stat-card"><div class="stat-value">{{ member.wins or 0 }}/{{ member.losses or 0 }}</div><div class="stat-label">Duel W/L</div></div>
        <div class="stat-card"><div class="stat-value">{{ member.raid_participation or 0 }}</div><div class="stat-label">Raids</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODERATION ACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="action-panel">
        <h3>üõ°Ô∏è Moderation Actions</h3>
        <p class="action-note">Actions are queued and executed by the bot within ~30 seconds.</p>
        <div class="action-tabs">
            <button class="action-tab active" onclick="showActionTab(this,'warn')">‚ö†Ô∏è Warn</button>
            <button class="action-tab" onclick="showActionTab(this,'timeout')">üîá Timeout</button>
            <button class="action-tab" onclick="showActionTab(this,'xp')">‚ú® XP</button>
            <button class="action-tab" onclick="showActionTab(this,'coins')">üí∞ Coins</button>
            <button class="action-tab" onclick="showActionTab(this,'elo')">‚öîÔ∏è ELO</button>
        </div>

        <div class="action-form" id="tab-warn">
            <form method="POST" action="/staff/action/warn/{{ member.user_id }}">
                <label>Category</label>
                <select name="category" required>
                    <optgroup label="Minor (1-2 pts)">
                        {% for cid, cat in warn_categories.items() if cat.points <= 2 %}
                        <option value="{{ cid }}">{{ cat.name }} ({{ cat.points }}pt{{ 's' if cat.points != 1 }})</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Moderate (3-5 pts)">
                        {% for cid, cat in warn_categories.items() if cat.points >= 3 and cat.points <= 5 %}
                        <option value="{{ cid }}">{{ cat.name }} ({{ cat.points }}pts)</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="üö´ Instant Ban">
                        {% for cid, cat in warn_categories.items() if cat.get('instant_ban') %}
                        <option value="{{ cid }}">‚õî {{ cat.name }}</option>
                        {% endfor %}
                    </optgroup>
                </select>
                <label>Reason (optional)</label>
                <input type="text" name="reason" placeholder="Additional details..." maxlength="200">
                <button type="submit" class="btn btn-danger">Issue Warning</button>
            </form>
        </div>

        <div class="action-form hidden" id="tab-timeout">
            <form method="POST" action="/staff/action/timeout/{{ member.user_id }}">
                <label>Duration</label>
                <select name="duration">
                    <option value="5">5 minutes</option>
                    <option value="10" selected>10 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="360">6 hours</option>
                    <option value="1440">24 hours</option>
                    <option value="10080">7 days</option>
                </select>
                <label>Reason</label>
                <input type="text" name="reason" placeholder="Reason for timeout..." maxlength="200">
                <button type="submit" class="btn btn-danger">Apply Timeout</button>
            </form>
        </div>

        <div class="action-form hidden" id="tab-xp">
            <form method="POST" action="/staff/action/adjust_xp/{{ member.user_id }}">
                <label>XP Amount (negative to remove)</label>
                <input type="number" name="amount" placeholder="e.g. 500 or -200" required>
                <button type="submit" class="btn btn-primary">Adjust XP</button>
            </form>
        </div>

        <div class="action-form hidden" id="tab-coins">
            <form method="POST" action="/staff/action/adjust_coins/{{ member.user_id }}">
                <label>Coin Amount (negative to remove)</label>
                <input type="number" name="amount" placeholder="e.g. 1000 or -500" required>
                <label>Reason</label>
                <input type="text" name="reason" placeholder="Reason for adjustment..." maxlength="200">
                <button type="submit" class="btn btn-primary">Adjust Coins</button>
            </form>
        </div>

        <div class="action-form hidden" id="tab-elo">
            <form method="POST" action="/staff/action/set_elo/{{ member.user_id }}">
                <label>New ELO Rating</label>
                <input type="number" name="elo" value="{{ member.elo_rating or 1000 }}" min="0" max="3000" required>
                <button type="submit" class="btn btn-primary">Set ELO</button>
            </form>
        </div>
    </div>

    <!-- Attendance & Inventory -->
    <div class="raids-two-col">
        <div class="profile-section-card">
            <h3>üìÖ Attendance</h3>
            <div class="stat-rows">
                <div class="stat-row"><span>Trainings</span><span>{{ member.training_attendance or 0 }}</span></div>
                <div class="stat-row"><span>Tryouts</span><span>{{ member.tryout_attendance or 0 }}</span></div>
                <div class="stat-row"><span>Pass/Fail</span><span>{{ member.tryout_passes or 0 }}/{{ member.tryout_fails or 0 }}</span></div>
                <div class="stat-row"><span>Events Hosted</span><span>{{ member.events_hosted or 0 }}</span></div>
                <div class="stat-row"><span>Daily Streak</span><span>{{ member.daily_streak or 0 }}</span></div>
                <div class="stat-row"><span>Last Active</span><span>{{ member.last_active|timeago }}</span></div>
            </div>
        </div>
        <div class="profile-section-card">
            <h3>üéí Inventory</h3>
            {% if member.inventory_items %}
            {% for item in member.inventory_items %}<div class="inv-item"><span class="inv-name">{{ item.name }}</span></div>{% endfor %}
            {% else %}<p class="empty-text">Empty.</p>{% endif %}
        </div>
    </div>

    <!-- Warnings -->
    <div class="staff-card full-width">
        <h3>‚ö†Ô∏è Warnings ({{ warn_data.warnings|length }}) ‚Äî {{ warn_data.total_points or 0 }} active pts</h3>
        {% if warn_data.warnings %}
        <table class="mini-table">
            <thead><tr><th>ID</th><th>Category</th><th>Reason</th><th>Pts</th><th>Staff</th><th>Date</th><th>Status</th><th></th></tr></thead>
            <tbody>
            {% for w in warn_data.warnings %}
            <tr class="{% if w.get('expired',False) %}inactive{% endif %}">
                <td>{{ w.id or '‚Äî' }}</td>
                <td><span class="warn-cat">{{ w.category_name or w.category or '?' }}</span></td>
                <td>{{ w.reason or '‚Äî' }}</td>
                <td>{{ w.points or 0 }}</td>
                <td>{{ w.staff_id or '?' }}</td>
                <td>{{ (w.timestamp or '')[:10] }}</td>
                <td>{% if w.get('expired',False) %}‚ö™ Expired{% else %}üî¥ Active{% endif %}</td>
                <td>{% if not w.get('expired',False) %}<form method="POST" action="/staff/action/remove_warn/{{ member.user_id }}" style="display:inline"><input type="hidden" name="warning_id" value="{{ w.id }}"><button type="submit" class="btn-tiny btn-danger" title="Remove" onclick="return confirm('Remove warning #{{ w.id }}?')">‚úï</button></form>{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}<p class="empty-text">No warnings.</p>{% endif %}
    </div>

    <!-- Transactions -->
    {% if transactions %}
    <div class="staff-card full-width">
        <h3>üí∞ Recent Transactions</h3>
        <table class="mini-table">
            <thead><tr><th>Time</th><th>Type</th><th>Amount</th><th>Balance</th><th>Description</th></tr></thead>
            <tbody>
            {% for tx in transactions %}
            <tr>
                <td>{{ tx.created_at|timeago if tx.created_at else '?' }}</td>
                <td><span class="tx-type">{{ tx.tx_type or '?' }}</span></td>
                <td class="{% if tx.amount > 0 %}text-green{% else %}text-red{% endif %}">{{ '{:+,}'.format(tx.amount) }}</td>
                <td>{{ '{:,}'.format(tx.balance_after or 0) }}</td>
                <td>{{ (tx.description or '')[:60] }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Duels -->
    {% if duel_history %}
    <div class="staff-card full-width">
        <h3>‚öîÔ∏è Recent Duels</h3>
        <div class="duel-feed">{% for d in duel_history %}<div class="duel-item {% if d.winner == member.user_id|string %}won{% else %}lost{% endif %}"><span class="duel-result">{% if d.winner == member.user_id|string %}üèÜ WON{% else %}üíÄ LOST{% endif %}</span><span class="duel-elo-change">{% if d.winner == member.user_id|string %}{{ d.winner_elo_before }}‚Üí{{ d.winner_elo_after }}{% else %}{{ d.loser_elo_before }}‚Üí{{ d.loser_elo_after }}{% endif %}</span><span class="duel-date">{{ d.completed_at|timeago }}</span></div>{% endfor %}</div>
    </div>
    {% endif %}

    <!-- Action History -->
    {% if action_history %}
    <div class="staff-card full-width">
        <h3>üìã Dashboard Action History</h3>
        <table class="mini-table">
            <thead><tr><th>Time</th><th>Action</th><th>By</th><th>Status</th><th>Result</th></tr></thead>
            <tbody>
            {% for a in action_history %}
            <tr>
                <td>{{ a.created_at|timeago if a.created_at else '?' }}</td>
                <td>{{ a.action_type }}</td>
                <td>{{ a.staff_name or '?' }}</td>
                <td><span class="status-{{ a.status }}">{{ a.status }}</span></td>
                <td>{{ (a.result or '')[:60] }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if applications %}
    <div class="staff-card full-width">
        <h3>üìù Applications</h3>
        {% for a in applications %}<div class="app-row"><span>{{ a.position_title or a.position_id }}</span><span class="app-status status-{{ a.status }}">{{ a.status|title }}</span></div>{% endfor %}
    </div>
    {% endif %}
    {% endif %}
</section>
<script>
function showActionTab(btn, tab) {
    document.querySelectorAll('.action-form').forEach(f => f.classList.add('hidden'));
    document.querySelectorAll('.action-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.remove('hidden');
    btn.classList.add('active');
}
</script>
{% endblock %}
