{% extends "base.html" %}
{% block title %}Guardian System{% endblock %}
{% block content %}
<section class="section">
    <h2 class="section-title">ğŸ›¡ï¸ Guardian System</h2>
    <div class="staff-nav">
        <a href="/staff" class="staff-nav-link">Overview</a>
        <a href="/staff/members" class="staff-nav-link">Members</a>
        <a href="/staff/analytics" class="staff-nav-link">Analytics</a>
        <a href="/staff/guardian" class="staff-nav-link active">Guardian</a>
        <a href="/staff/audit" class="staff-nav-link">Audit Log</a>
    </div>

    {% if guardian and guardian.updated_at %}
    <p style="font-size:12px;color:var(--text-dim);margin-bottom:14px">Last sync: {{ guardian.updated_at|timeago }} â€” Stats refresh every 5 minutes from bot.</p>

    <div class="stat-grid compact">
        <div class="stat-card"><div class="stat-value">{{ guardian.commands_today or 0 }}</div><div class="stat-label">Commands Today</div></div>
        <div class="stat-card"><div class="stat-value">{{ guardian.errors_today or 0 }}</div><div class="stat-label">Errors Today</div></div>
        <div class="stat-card {% if guardian.active_abuse_flags %}accent{% endif %}"><div class="stat-value">{{ guardian.active_abuse_flags or 0 }}</div><div class="stat-label">Abuse Flags</div></div>
        <div class="stat-card"><div class="stat-value">{{ (guardian.restricted_users or [])|length }}</div><div class="stat-label">Restricted</div></div>
    </div>

    <div class="raids-two-col">
        <!-- Top Command Users -->
        <div class="profile-section-card">
            <h3>ğŸ“Š Top Command Users Today</h3>
            {% if guardian.top_users_today %}
            <div class="stat-rows">
                {% for u in guardian.top_users_today %}
                <div class="stat-row">
                    <span><a href="/staff/member/{{ u.user_id }}">{{ u.user_id }}</a></span>
                    <span>{{ u.count }} commands</span>
                </div>
                {% endfor %}
            </div>
            {% else %}<p class="empty-text">No command data yet today.</p>{% endif %}
        </div>

        <!-- Active Abuse Scores -->
        <div class="profile-section-card">
            <h3>âš ï¸ Active Abuse Scores</h3>
            {% if guardian.abuse_scores %}
            <div class="stat-rows">
                {% for uid, score in guardian.abuse_scores.items() %}
                <div class="stat-row">
                    <span><a href="/staff/member/{{ uid }}">{{ uid }}</a></span>
                    <span class="{% if score >= 8 %}warn-critical{% elif score >= 4 %}warn-high{% endif %}">Score: {{ score }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}<p class="empty-text">No active abuse flags.</p>{% endif %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <h3>Guardian Stats Not Available</h3>
        <p>The bot hasn't synced Guardian stats to the database yet. Stats sync every 5 minutes while the bot is running.</p>
        <p style="font-size:13px;color:var(--text-dim);margin-top:8px">Make sure the Guardian cog is loaded and the bot has the latest patches.</p>
    </div>
    {% endif %}

    <!-- Guardian Audit Events -->
    <div class="staff-card full-width" style="margin-top:16px">
        <h3>ğŸ“œ Guardian Events</h3>
        {% if guardian_events %}
        <table class="mini-table">
            <thead><tr><th>Time</th><th>Action</th><th>Target</th><th>Details</th></tr></thead>
            <tbody>
                {% for e in guardian_events %}
                <tr>
                    <td>{{ e.created_at|timeago if e.created_at else '?' }}</td>
                    <td><span class="audit-action">{{ e.action|replace('guardian_', '')|title }}</span></td>
                    <td>{% if e.target_id %}<a href="/staff/member/{{ e.target_id }}">{{ e.target_id }}</a>{% else %}â€”{% endif %}</td>
                    <td class="td-reason">{{ (e.details or '')[:80] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}<p class="empty-text">No guardian events logged yet.</p>{% endif %}
    </div>
</section>
{% endblock %}
